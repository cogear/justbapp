// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"] // Enable pgvector extension
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  extensions = [vector] // Enable pgvector extension
}

// User Profile
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Progressive Profiling
  // Stored as JSON or separate tables, but for "Long-Term Memory", we use vectors.
  // We can also store explicit traits.
  psychographicProfile String? // e.g. "The Sponge", "The Fixer"
  
  // Long-Term Memory Vectors
  // Stores the aggregated embedding of user's journal entries and preferences
  // Used to tailor content and "News Refiner"
  memoryVector Unsupported("vector(1536)")? 

  // Relations
  dailyPulses   DailyPulse[]
  journalEntries JournalEntry[]
  visualProfiles VisualProfile[]
}

// Visual Personality Profile
model VisualProfile {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  // OCEAN Traits (0-100)
  openness          Int
  conscientiousness Int
  extraversion      Int
  agreeableness     Int
  neuroticism       Int

  // Top Interests (Stored as JSON or array of strings)
  interests String[] // e.g. ["IAB1", "IAB17"]

  // Personality Cluster (e.g. "Role Model", "Explorer")
  cluster String?

  // Relations
  interactions UserInteraction[]
}

// News 2.0 Models

model NewsArticle {
  id          String   @id @default(uuid())
  originalUrl String   @unique
  title       String
  description String?
  content     String   // Full scraped content
  imageUrl    String?
  source      String?
  publishedAt DateTime
  
  // Metadata
  tags        String[] // e.g. ["Tech", "Politics", "Health"]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  reframedArticles ReframedArticle[]
  interactions     UserInteraction[]
}

model ReframedArticle {
  id            String   @id @default(uuid())
  newsArticleId String
  newsArticle   NewsArticle @relation(fields: [newsArticleId], references: [id])
  
  cluster       String   // The personality cluster this is targeted for (e.g. "Explorer")
  
  headline      String
  summary       String   // Teaser summary
  content       String   // Full reframed content
  tone          String?  // e.g. "Optimistic", "Analytical"
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([newsArticleId, cluster]) // One reframe per cluster per article
}

model UserInteraction {
  id            String   @id @default(uuid())
  userId        String
  user          VisualProfile @relation(fields: [userId], references: [id]) // Linking to VisualProfile for cluster context
  
  newsArticleId String
  newsArticle   NewsArticle @relation(fields: [newsArticleId], references: [id])
  
  type          String   // "CLICK", "VIEW", "LIKE", "DISMISS"
  createdAt     DateTime @default(now())
}

// The Daily Pulse: "Where is your energy right now?"
model DailyPulse {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  // Energy Scales (1-10 or -5 to +5)
  anxiousCalm    Int // Anxious <-> Calm
  scatteredFocused Int // Scattered <-> Focused
  drainedEnergized Int // Drained <-> Energized

  // Context
  note String?
}

// The Insight Question: Reflective journaling
model JournalEntry {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  question String // e.g. "What is one thing you are dreading?"
  questionId String? // ID from the predefined question list
  answer   String

  // Vector embedding of the answer for semantic search/memory
  embedding Unsupported("vector(1536)")?
}

// b. Local Events
model Event {
  id          String   @id @default(uuid())
  title       String
  description String
  location    String
  date        DateTime
  
  // "Nourishing" keywords tags
  tags String[] // e.g. "Garden", "Silent"

  // Discovery Pipeline Fields
  sourceUrl   String?
  latitude    Float?
  longitude   Float?
  zipCode     String?
  category    String? // e.g. "Low Key", "Social", "Class", "Nature"
  rawText     String? // For provenance/debugging

  // Social Proof
  attendeeCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
